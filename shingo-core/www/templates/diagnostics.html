{{define "content"}}
<div class="flex flex-between mb-2">
  <h1>Logs</h1>
  <div class="flex gap-1" style="align-items:center;">
    <select id="log-filter" onchange="debugFilter()" style="font-size:0.85rem;padding:2px 6px;">
      <option value="">All subsystems</option>
      {{range .Subsystems}}
      <option value="{{.}}" {{if eq . $.Subsystem}}selected{{end}}>{{.}}</option>
      {{end}}
    </select>
    <label style="display:inline;font-weight:normal;font-size:0.85rem;cursor:pointer;">
      <input type="checkbox" id="log-autoscroll" checked> Auto-scroll
    </label>
    <button class="btn btn-sm btn-danger" onclick="debugClear()">Clear</button>
  </div>
</div>

<div class="card" style="padding:0;">
  <div class="debug-log-wrap">
    <table class="debug-log-table">
      <thead>
        <tr>
          <th style="width:160px;">Time</th>
          <th style="width:120px;">Subsystem</th>
          <th>Message</th>
        </tr>
      </thead>
      <tbody id="debug-log-body">
        {{range .Entries}}
        <tr class="debug-row" data-subsystem="{{.Subsystem}}">
          <td>{{.Time.Format "15:04:05.000"}}</td>
          <td>{{.Subsystem}}</td>
          <td>{{.Message}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
</div>

<script>
(function() {
  var body = document.getElementById('debug-log-body');
  var wrap = document.querySelector('.debug-log-wrap');
  var autoScroll = document.getElementById('log-autoscroll');
  var filterEl = document.getElementById('log-filter');
  var maxRows = 1000;

  window.debugAppendRow = function(entry) {
    var tr = document.createElement('tr');
    tr.className = 'debug-row';
    tr.setAttribute('data-subsystem', entry.subsystem || '');
    var ts = entry.time ? new Date(entry.time) : new Date();
    var timeStr = ts.toTimeString().slice(0, 8) + '.' + String(ts.getMilliseconds()).padStart(3, '0');
    tr.innerHTML = '<td>' + timeStr + '</td><td>' + (entry.subsystem || '') + '</td><td>' + escapeHtml(entry.message || '') + '</td>';
    // Hide if filter is active and doesn't match
    var f = filterEl.value;
    if (f && entry.subsystem !== f) {
      tr.style.display = 'none';
    }
    body.appendChild(tr);
    while (body.children.length > maxRows) {
      body.removeChild(body.firstChild);
    }
    if (autoScroll.checked) {
      wrap.scrollTop = wrap.scrollHeight;
    }
  };

  window.debugClear = function() {
    body.innerHTML = '';
  };

  window.debugFilter = function() {
    var f = filterEl.value;
    var rows = body.querySelectorAll('tr');
    for (var i = 0; i < rows.length; i++) {
      if (!f || rows[i].getAttribute('data-subsystem') === f) {
        rows[i].style.display = '';
      } else {
        rows[i].style.display = 'none';
      }
    }
  };

  function escapeHtml(s) {
    var d = document.createElement('div');
    d.appendChild(document.createTextNode(s));
    return d.innerHTML;
  }

  // Auto-scroll to bottom on load
  if (autoScroll.checked) {
    wrap.scrollTop = wrap.scrollHeight;
  }
})();
</script>
{{end}}
